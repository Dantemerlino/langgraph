<article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Advanced Data Lake</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Longitudinal Patient Record</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">LPR (FHIR) Data</span><meta itemprop="position" content="3"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Optimized FHIR BigQuery Resources Overview</span><meta itemprop="position" content="4"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">BiqQuery Best Practices and Example Queries</span><meta itemprop="position" content="5"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>BiqQuery Best Practices and Example Queries</h1></header><p>There are several techniques that can be used to improve query efficiency. A full list of recommendations from Google can be found <a href="https://cloud.google.com/bigquery/docs/best-practices-performance-compute" target="_blank" rel="noopener noreferrer">here</a>, and below is a summary of the most effective.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="target-specific-columns">Target Specific Columns<a href="#target-specific-columns" class="hash-link" aria-label="Direct link to Target Specific Columns" title="Direct link to Target Specific Columns">​</a></h3>
<p>Avoid using "Select *" wherever possible. If you are selecting from a table, you can utilize data previewing to decide what columns to use ahead of time. You can find the preview tab by searching for the table via BigQuery in the Google Cloud Console.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Targeted Columns Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Inefficient, returns the entire table</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token operator" style="color: rgb(137, 221, 255);">*</span><span class="token plain"> </span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Instead, use something like this</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="joining-tables">Joining Tables<a href="#joining-tables" class="hash-link" aria-label="Direct link to Joining Tables" title="Direct link to Joining Tables">​</a></h3>
<p>Though there are several connecting fields between tables, i.e. patient_id and encounter_id, it is best to use the partitioned field wherever possible. For all tables with patient data, this is the clinic_number(MRN).</p>
<p>To find what field(s) are partitioned or clustered, go to BigQuery in Google Cloud Console &gt; Search for your table and open it in a new tab &gt; Select the Details tab &gt; If a partition exists, you will find the field under "Partitioned on field."
If a cluster exists, you will find the field(s) under "Clustered by."</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Join on Patitioned Value Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Encounter</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat on enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Avoid using Outer Joins when possible. When not possible, use Inner Joins before Outer Joins as this will reduce the number of records sooner.</p>
<p>Always join the largest table to the smallest table and then decreasing size after (ex: 1000, 5, 500, 300, 200). In the example below, Encounter is the largest of the three tables, hence its position as the FROM table. Encounter is joined to Patient, the smallest of the three tables, followed by DiagnosticReport.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Multiple Joins Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">code_text</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Encounter</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> enc </span><span class="token operator" style="color: rgb(137, 221, 255);">--</span><span class="token number" style="color: rgb(247, 140, 108);">501</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">860</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">067</span><span class="token plain"> rows</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat on enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">--</span><span class="token number" style="color: rgb(247, 140, 108);">11</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">662</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">759</span><span class="token plain"> rows</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.DiagnosticReport</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> dr on dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> and dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">--</span><span class="token number" style="color: rgb(247, 140, 108);">135</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">676</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token number" style="color: rgb(247, 140, 108);">715</span><span class="token plain"> rows</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Joins should be done on Bool or Int fields instead of Strings.</p>
<p>Additionally, filters on Joined tables should be placed within the Join as part of the ON condition to drop records sooner rather than later as seen below.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Filters Within Joins Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">code_text</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Encounter</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat on enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> and </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">40</span><span class="token plain"> and pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.DiagnosticReport</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> dr on dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> and dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="best-practice-for-filters">Best Practice for Filters<a href="#best-practice-for-filters" class="hash-link" aria-label="Direct link to Best Practice for Filters" title="Direct link to Best Practice for Filters">​</a></h3>
<p>Filters should be ordered by type: Partition, Cluster, Bool, Int, Float, Date, String. Filters should also be ordered by most selective (=, !=) before least selective (In, &gt;, &lt;, Like).</p>
<p>When filtering, if a table has a partition, the partition must be the first field filtered or you will likely see degredation. Even if you aren't querying on a partitioned field, you should still include it in the filter as it will improve query efficiency. Then, any clustered fields should be filtered in order by how they are listed in the BQ Console (to find the partition or clustered fields, see the section under Joining Tables).</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Order of Filters Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">where pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">40</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">UPPER</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'MARRIED'</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">UPPER</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_state</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">IN</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'MINNESOTA'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'WISCONSIN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token string" style="color: rgb(195, 232, 141);">'MN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token string" style="color: rgb(195, 232, 141);">'WI'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you have to convert a value to filter on it (ex: Int = String), cast the String if possible because Integer comparisons are more efficient. Similarly, if filtering on a Date field, pass a Date instead of a String.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Cast Filtered Values Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_postal_code</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">where pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">12007729</span><span class="token plain"> and pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'1980-12-13'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> and </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_postal_code</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">INT</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">54670</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-of-temporary-tables">Use of Temporary Tables<a href="#use-of-temporary-tables" class="hash-link" aria-label="Direct link to Use of Temporary Tables" title="Direct link to Use of Temporary Tables">​</a></h3>
<p>Like the WHERE clause in the first example, Temp Tables or CTEs (Common Table Expressions) can be used to filter data before it is used in a larger query. A Temp Table or CTE should be used instead of sub-queries, when you need to join to the same data more than once, or any time you need to join to a large table.</p>
<p>A Temp Table is stored in tempdb and can be indexed and have column statistics. The table will be automatically removed from memory 24 hours after creation. A CTE is a temporary result set used within a query - it cannot be reused in multiple queries like a Temp Table.</p>
<p>Below is an example of using multiple Temp Tables and CTEs in a query to limit the data to encounters from 2019.</p>
<p>Although one may seem more appropriate for your needs, the other may still perform better for your specific query (as you can see in the examples below), so try both and see which is more efficient for your query.</p>
<p>Note the use of filters within the the Temp Tables and CTEs. Using filters in this way reduces the total rows faster - decreasing the overall cost of the query.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Multiple Temp Table Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Average Slot Usage: 35 slots</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Average Elapsed Time: 6 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">CREATE</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">TEMP</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">TABLE</span><span class="token plain"> encounter_temp </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">patient_id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">FROM</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Encounter</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">WHERE</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'2019-01-01'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&lt;=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'2019-12-31'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">CREATE</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">TEMP</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">TABLE</span><span class="token plain"> patient_temp </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">FROM</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">WHERE</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">UPPER</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_state</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">IN</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'MINNESOTA'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'WISCONSIN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'MN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'WI'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">patient_id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">code_text</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> encounter_temp enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join  patient_temp pat on enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">INNER</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">JOIN</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.DiagnosticReport</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> dr on dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> and dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Multiple CTE Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Average Slot Usage: 52 slots</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Average Elapsed Time: 2 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">WITH</span><span class="token plain"> encounter_cte </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">patient_id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">FROM</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Encounter</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">WHERE</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'2019-01-01'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">period_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&lt;=</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'2019-12-31'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"> patient_cte </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">FROM</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">WHERE</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">AND</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">UPPER</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_state</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">IN</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token string" style="color: rgb(195, 232, 141);">'MINNESOTA'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'WISCONSIN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'MN'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">'WI'</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">patient_id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">EncID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_start</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_end</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">family_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">given_name</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">general_practitioner</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">code_text</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> encounter_cte enc</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">inner join  patient_cte pat on enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token constant" style="color: rgb(130, 170, 255);">INNER</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">JOIN</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.DiagnosticReport</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> dr on dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> and dr</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> enc</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">encounter_number</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="miscellaneous">Miscellaneous<a href="#miscellaneous" class="hash-link" aria-label="Direct link to Miscellaneous" title="Direct link to Miscellaneous">​</a></h3>
<p>Instead of DISTINCT, do a GROUP BY of any selected fields. In BigQuery, DISTINCT does a distinct of every field selected which is non-performant.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Group By Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">MAX</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">last_updated</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">group by </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">having pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Group By All Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">group by all</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">having pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">14000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Instead of traditional expressions (i.e. CURRENT_DATE - 5) use BQ functions (i.e. DATE_SUB(CURRENT_DATE, INTERVAL 5 DAY)). A list of functions can be found <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-all" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Instead of Row_Number, use Array_Agg when trying to get just the first or last field. Array_Agg runs more efficiently because the ORDER BY is allowed to drop everything except the top record on each GROUP BY.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockTitle_Ktv7">Array_Agg Example</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color: rgb(191, 199, 213); background-color: rgb(41, 45, 62);"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">//Returns the latest update by patient</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">select</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE_DIFF</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token constant" style="color: rgb(130, 170, 255);">CURRENT_DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">SAFE_CAST</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain">pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">birth_date</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">DATE</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">YEAR</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Age</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_birthsex</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">Sex</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">marital_status</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">us_core_race_text</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">address_home_line1</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token constant" style="color: rgb(130, 170, 255);">AS</span><span class="token plain"> </span><span class="token maybe-class-name">PatID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  pat_latest_update</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  select </span><span class="token function" style="color: rgb(130, 170, 255);">array_agg</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat order by pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">last_updated</span><span class="token plain"> desc limit </span><span class="token number" style="color: rgb(247, 140, 108);">1</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">[</span><span class="token function" style="color: rgb(130, 170, 255);">offset</span><span class="token punctuation" style="color: rgb(199, 146, 234);">(</span><span class="token number" style="color: rgb(247, 140, 108);">0</span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><span class="token punctuation" style="color: rgb(199, 146, 234);">]</span><span class="token plain"> pat_latest_update</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token keyword module" style="font-style: italic;">from</span><span class="token plain"> </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    </span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token template-string string" style="color: rgb(195, 232, 141);">ml-mps-adl-intfhr-phi-p-3b6e.phi_primary_use_fhir_clinicnumber_us_p.Patient</span><span class="token template-string template-punctuation string" style="color: rgb(195, 232, 141);">`</span><span class="token plain"> pat</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  group by </span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">    pat</span><span class="token punctuation" style="color: rgb(199, 146, 234);">.</span><span class="token property-access">clinic_number</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" class="clean-btn" aria-label="Toggle word wrap" title="Toggle word wrap"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_Bwma" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The LIMIT function only limits the amount of records returned not the amount searched. As such, it will not reduce the cost of a query.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="additional-resources">Additional Resources<a href="#additional-resources" class="hash-link" aria-label="Direct link to Additional Resources" title="Direct link to Additional Resources">​</a></h3>
<p><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-compute" target="_blank" rel="noopener noreferrer">Google Documentation - Optimize query computation</a></p>
<p><a href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-admin-reference-guide-query-optimization" target="_blank" rel="noopener noreferrer">BigQuery Admin reference guide: Query optimization</a></p>
<p><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-overview" target="_blank" rel="noopener noreferrer">BigQuery Best Practices</a></p>
<p><a href="https://cloud.google.com/bigquery/docs/history-based-optimizations" target="_blank" rel="noopener noreferrer">History Based Optimizations</a></p></div></article>